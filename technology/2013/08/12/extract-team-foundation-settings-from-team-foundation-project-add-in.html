<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    Extract Team Foundation settings from Team Foundation project add-in - Queryinterface to know more
    
  </title>

  <meta name="description" content="&amp;nbsp; One of my project manager friends approached me with a request recently. He wanted a &quot;working&quot; project add-in, that will help him sync certain attribu...">

  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="/assets/vendor/bootstrap/css/bootstrap.min.css">

  <link rel="stylesheet" href="/assets/vendor/fontawesome-free/css/all.min.css">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/technology/2013/08/12/extract-team-foundation-settings-from-team-foundation-project-add-in.html">
  <link rel="alternate" type="application/rss+xml" title="Queryinterface to know more" href="/feed.xml">

</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">Queryinterface to know more</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">Posts</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/contact">Contact</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->

  <header class="masthead">
    
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>Extract Team Foundation settings from Team Foundation project add-in</h1>
            
            <span class="meta">Posted by
              <a href="#">{"display_name"=>"arkumar", "login"=>"arkumar", "email"=>"ar.kumar@gmail.com", "url"=>""}</a>
              on August 12, 2013 &middot; <span class="reading-time" title="Estimated read time">
  
   4 mins  read </span>

            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">

        <p>&nbsp;
<p align="justify">One of my project manager friends approached me with a request recently. He wanted a "working" project add-in, that will help him sync certain attributes of the Project tasks with the corresponding work items in Team Foundation server. According to him, the built-in TFS add-in doesn&rsquo;t work half the time, and when it works, it completely screws up the project file, making it unusable.
<p align="justify">Storing the configuration settings for this add-in posed some interesting problems for me. Initially I started out by storing the Team Foundation settings, URL, Team Project etc. in a .config file, thought I felt that this was not a good design. Since these configuration settings will be different for each project file (.mpp), storing these in a configuration file is definitely not a good idea.&nbsp; I started exploring a different path. If Team foundation Add-in for Microsoft Porject (for that matter, excel also) is storing these settings for each project file, why can&rsquo;t we read those settings instead of designing our own configuration storage settings
<p align="justify">The below diagram shows the custom properties of a Microsoft Project file.
<p align="justify"><a href="http://iunknownme.com/blog/wp-content/uploads/2013/08/image.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://iunknownme.com/blog/wp-content/uploads/2013/08/image_thumb.png" width="229" height="283"></a>&nbsp;
<p align="justify">In the above diagram you can see some custom properties with the name starting &ldquo;VS Team System Data DO NOT EDIT&rdquo; Team foundation add-in stores various configuration settings against these property names. However the values against each of these property names are Base64 encoded. In fact, Team foundation add-in constructs the settings as single xml file, encodes it, splits it into thirty odd segments (as you can see from the number of property names) and stores them as custom property values<br />
<h3>Code to read custom properties</h3>
<p align="justify">In order to read these settings, you have to combine these settings, decode and uncompress, which will&nbsp;&nbsp; produce a single monolithic xml, containing all the configuration settings. Once you have the xml loaded into memory, you can use Linq to XML to read individual configuration settings like Team foundation server name, Team foundation project name etc.</p>
<p align="justify">Combine all the custom &ldquo;VS&rdquo; property values into a string builder</p>
<pre class="brush: csharp;">project = app.ActiveProject;
if (project == null) return;
var properties = (DocumentProperties)app.ActiveProject.CustomDocumentProperties;

string VSTSSystemData = "VS Team System Data DO NOT EDIT";
int propCount = 0;
try
{
    propCount=(int)properties[VSTSSystemData].Value;
}
catch (ArgumentException argex)
{
    //throw new ApplicationException("Project is not connected to TFS");
    MessageBox.Show("Project is not connected to TFS");
    return;
}
StringBuilder sb = new StringBuilder();

for (int i = 0; i < propCount; i++)
{
    sb.Append((string)properties[VSTSSystemData + i].Value);
}
</pre>
<p>Decode the base 64 bit encoded string</p>
<p>&nbsp;</p>
<pre class="brush: csharp;">char[] chars = sb.ToString().ToCharArray();
byte[] encodedDataAsBytes = System.Convert.FromBase64String(sb.ToString());
</pre>
<p>Before you load the decoded string to an XML document, you have to omit the first&nbsp; bits of the array. These 8 bits store some settings specific to the encoding and compression.</p>
<pre class="brush: csharp;">byte[] result = new byte[encodedDataAsBytes.Length - 8];
Array.Copy(encodedDataAsBytes,8, result, 0, encodedDataAsBytes.Length - 8);
MemoryStream s = new MemoryStream(result);
</pre>
<p>Now you have compressed data in a memory stream. You can deflate this memory stream and load the it into a XDocument to access the various Team Foundation configuration settings.
<pre class="brush: csharp;">using (var df = new System.IO.Compression.DeflateStream(s, System.IO.Compression.CompressionMode.Decompress, true))
{
    var doc = XDocument.Load(df);
    var tfsservernode = (from x in doc.Descendants("V")
                where x.Attribute("n").Value == "namespaceUrl"
                select x).FirstOrDefault();
    if (tfsservernode == null) { MessageBox.Show("Could not find TFS server name"); return; }
    tfsservername = tfsservernode.Value;
    if (string.IsNullOrEmpty(tfsservername)) { MessageBox.Show("TFS server name is empty"); return; } 
    var projectnode = (from x in doc.Descendants("V")
                       where x.Attribute("n").Value == "project"
                         select x).FirstOrDefault();
    projectname = projectnode.Value;
}
</pre>
<blockquote>
<p align="justify">Please note, the above steps apply to Microsoft Project 2010. However the format, Team foundation add-in, encodes and compresses these settings are undocumented and proprietary. Please use these at your own risk</p>
</blockquote>


        <hr>

        <div class="clearfix">

          
          
          <a class="btn btn-primary float-right" href="/technology/2013/08/12/64-bit-installer-for-your-vsto-add-in.html" data-toggle="tooltip" data-placement="top" title="64-bit Installer for your VSTO add-in">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          

        </div>

      </div>
    </div>
  </div>


  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:your-email@example.com">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://twitter.com/jekyllrb">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          
          <li class="list-inline-item">
            <a href="https://github.com/jekyll">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="copyright text-muted">Copyright &copy;  2019</p>
      </div>
    </div>
  </div>
</footer>


  <script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/clean-blog.min.js"></script>

<script src="/assets/scripts.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '');
</script>



</body>

</html>
